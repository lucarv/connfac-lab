# LAB 2 - Edge Intelligence
For this lab we will implement the same architecture as in LAB 1, but we will be moving some of the work to the factory floor. For that we will deploy an Azure Edge Device.  


![](images/architecture2-2.png )
## Provision an Azure Edge Device  

First we will pre-provision a device identity in IoT Hub, using symmetric keys generated by Azure (NOte that this is not a best practice for production, we will do it for educational purposes only)  

![](images/provision2hub.png )


## Prepare the physical device  
In this lab we will be deploying an edge device on a Raspberry Pi 3. 
Connect to the device via ssh (or putty if you are on a Windows PC).  
As we have learnt, Azure Edge is a SW component depolyrf on COTS HW running Windows or Linux (which You will use).  We also learnt that Edge runs a microservices architecture on docker, so we will first install that on the device.  

### Download and install the moby-engine
curl -L https://aka.ms/moby-engine-armhf-latest -o moby_engine.deb && sudo dpkg -i ./moby_engine.deb

### Download and install the moby-cli
curl -L https://aka.ms/moby-cli-armhf-latest -o moby_cli.deb && sudo dpkg -i ./moby_cli.deb

### Run fix
sudo apt install -f

### Download and install the standard libiothsm implementation
curl -L https://aka.ms/libiothsm-std-linux-armhf-latest -o libiothsm-std.deb && sudo dpkg -i ./libiothsm-std.deb

### Download and install the IoT Edge Security Daemon
curl -L https://aka.ms/iotedged-linux-armhf-latest -o iotedge.deb && sudo dpkg -i ./iotedge.deb

### Run fix
sudo apt install -f   

At this point we are ready to connect the Edge Device to the Cloud. We need to provision the symmetric key to the device and for this lab we will do it manually by editing the Edge config file and pasting the Edge connection string we provisioned earlier in this lab:   
> sudo nano /etc/iotedge/config.yaml  

Once you have done it, reboot the security daemon by running the following command on the terminal:  
> systemctl restart iotedge

You can verify that the Edge Device is ready to be further configured by means of a deployment manifest. A manifest is a json document containing modules and pipelines.
Modules can be downloaded from any docker repository, and some of them are available at the Edge Market place on the Azure Portal. We will fetch a module that will simulate a device sending telemetry.  

To deploy your first module from the Azure Marketplace, use the following steps:
1. In the Azure portal, enter Simulated Temperature Sensor into the search and open the Marketplace result.
2. Choose an IoT Edge device to receive this module. On the Target Devices for IoT Edge Module page, provide the appropriate info. Select "Create". This will take you back to the device pane on the portal, it will show the module in the list of deployment modules.
3. We will only deploy one module now, so press "Next" to configure the pipeline. 
4. For now, you want all messages from all modules to go to IoT Hub ($upstream). It's  autopopulated, just select "Next"
5. The next pane will show you the deployment manifest. Take a minute to inspect the JSON file. Then press "Submit". The deployment manifest is then sent to the edge device, while the Portal will take you back to your device list pane.
6. Select your device, check that the modules were deployed correctly

![](images/manifestready.png )


### View generated data
In this quickstart, you created a new IoT Edge device and installed the IoT Edge runtime on it. Then, you used the Azure portal to push an IoT Edge module to run on the device without having to make changes to the device itself. In this case, the module that you pushed creates environmental data that you can use for the tutorials. 

Open the command prompt on the computer running your simulated device again. Confirm that the module deployed from the cloud is running on your IoT Edge device. View the messages being sent from the tempSensor module to the cloud:
> sudo iotedge logs -f SimulatedTemperatureSensor  

You can also verify the D2C messages using the device explorer or visual code.
### Create a Stream Analytics job
Instead of sending every single reading from the device, let's save connectivity costs by only send averages. We will also want to repeat the behaviour of the previous lab, where we will reset the device once the temperature reach a threshold. 
First we need to create a container to store the jobs that will be sent to the edge. 

![](images/newcontainer.png )

### Create a new job

In the Azure portal, go to Create a resource > Internet of Things > Stream Analytics Job. W have already done this once, the difference is that now we will choose "Edge" as Hosting environment. As before, we need to configure a source (input), a query and a sink (output). In the Edge case both input and output will be Edge Hub (for reasons that should be clear to us now). For the query, we will replace the default quesry with the following query:
```
SELECT  
    'reset' AS command 
INTO 
   alert 
FROM 
   temperature TIMESTAMP BY timeCreated 
GROUP BY TumblingWindow(second,30) 
HAVING Avg(machine.temperature) > 70
```
Save the job. We also need to store the job in the container we created above. Choose "Storage account settings" on the Configure Menu.

### Deploy the job

You are now ready to deploy the Azure Stream Analytics job on your IoT Edge device.

In this section, you use the Set Modules wizard in the Azure portal to create a new deployment manifest. We have already deployed a temperature simulator. We will now add your Stream Analytics job. We will then create a pipeline that will connect these together and further to the cloud.

1. In the Azure portal, in your IoT hub, go to IoT Edge, and then open the details page for your IoT Edge device.  Click on Set modules.

![](images/setmod.png )

2. Click Add and select Azure Stream Analytics Module.
3. Select your subscription and the Azure Stream Analytics Edge job that you created.
4. Select Save.
5. Make a note of the name of your Stream Analytics module because you'll need it in the next step, then select Next to continue.
6. Replace the default value in Routes with the following code. Update all three instances of {moduleName} with the name of your Azure Stream Analytics module.

``` 
{
    "routes": {
        "telemetryToCloud": "FROM /messages/modules/SimulatedTemperatureSensor/* INTO $upstream",
        "alertsToCloud": "FROM /messages/modules/{moduleName}/* INTO $upstream",
        "alertsToReset": "FROM /messages/modules/{moduleName}/* INTO BrokeredEndpoint(\"/modules/SimulatedTemperatureSensor/inputs/control\")",
        "telemetryToAsa": "FROM /messages/modules/SimulatedTemperatureSensor/* INTO BrokeredEndpoint(\"/modules/{moduleName}/inputs/temperature\")"
    }
}
```

{
  "routes": {
    "telemetryToCloud": "FROM /messages/modules/SimulatedTemperatureSensor/* INTO $upstream",
    "alertsToCloud": "FROM /messages/modules/IotEdgeJob/* INTO $upstream",
    "alertsToReset": "FROM /messages/modules/IotEdgeJob/* INTO BrokeredEndpoint(\"/modules/SimulatedTemperatureSensor/inputs/control\")",
    "telemetryToAsa": "FROM /messages/modules/SimulatedTemperatureSensor/* INTO BrokeredEndpoint(\"/modules/IotEdgeJob/inputs/temperature\")"
  }
}

1. The routes that you declare here define the flow of data through the IoT Edge device. The telemetry data from the SimulatedTemperatureSensor module are sent to IoT Hub and to the temperature input that was configured in the Stream Analytics job. The alert output messages are sent to IoT Hub and to the tempSensor module to trigger the reset command.
2. Select Next.
3. In the Review Deployment step, select Submit.
4.  Return to the device details page, and then select Refresh.
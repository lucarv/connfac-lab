# LAB 2 - Edge Intelligence
For this lab we will implement the same architecture as in LAB 1, but we will be moving some of the work to the factory floor. For that we will deploy an Azure Edge Device.  


![](images/architecture2-2.png )
## Provision an Azure Edge Device  

First we will pre-provision a device identity in IoT Hub, using symmetric keys generated by Azure (NOte that this is not a best practice for production, we will do it for educational purposes only)  

![](images/provision2hub.png )


## Prepare the physical device  
In this lab we will be deploying an edge device on a Raspberry Pi 3. 
Connect to the device via ssh (or putty if you are on a Windows PC).  
As we have learnt, Azure Edge is a SW component depolyrf on COTS HW running Windows or Linux (which You will use).  We also learnt that Edge runs a microservices architecture on docker, so we will first install that on the device.  

### Download and install the moby-engine
curl -L https://aka.ms/moby-engine-armhf-latest -o moby_engine.deb && sudo dpkg -i ./moby_engine.deb

### Download and install the moby-cli
curl -L https://aka.ms/moby-cli-armhf-latest -o moby_cli.deb && sudo dpkg -i ./moby_cli.deb

### Run fix
sudo apt install -f

### Download and install the standard libiothsm implementation
curl -L https://aka.ms/libiothsm-std-linux-armhf-latest -o libiothsm-std.deb && sudo dpkg -i ./libiothsm-std.deb

### Download and install the IoT Edge Security Daemon
curl -L https://aka.ms/iotedged-linux-armhf-latest -o iotedge.deb && sudo dpkg -i ./iotedge.deb

### Run fix
sudo apt install -f   

At this point we are ready to connect the Edge Device to the Cloud. We need to provision the symmetric key to the device and for this lab we will do it manually by editing the Edge config file and pasting the Edge connection string we provisioned earlier in this lab: 
sudo nano /etc/iotedge/config.yaml  
Once you have done it, reboot the security daemon by running the following command on the terminal:
systemctl restart iotedge

At this point, you can verify that the Edge Device is ready to be further configured by adding modules and pipelines. As we have learnt, this is done by pushing a deployment manifest to the edge device. We will do that from the Portal.  

![](images/manifestready.png )


### View generated data
In this quickstart, you created a new IoT Edge device and installed the IoT Edge runtime on it. Then, you used the Azure portal to push an IoT Edge module to run on the device without having to make changes to the device itself. In this case, the module that you pushed creates environmental data that you can use for the tutorials. 

Open the command prompt on the computer running your simulated device again. Confirm that the module deployed from the cloud is running on your IoT Edge device. View the messages being sent from the tempSensor module to the cloud:
> sudo iotedge logs -f SimulatedTemperatureSensor

### Create a Stream Analytics job
Instead of sending every single reading from the device, let's save connectivity costs by only send averages.  
First we need to create a container to store the jobs that will be sent to the edge. 

![](images/newcontainer.png )

### Create a new job

In the Azure portal, go to Create a resource > Internet of Things > Stream Analytics Job. W have already done this once, the difference is that now we will choose "Edge" as Hosting environment. As before, we need to configure a source (input), a query and a sink (output). In the Edge case both input and output will be Edge Hub (for reasons that should be clear to us now).

